# 📄 Waller（仮）要件定義書 v0.4（MVP確定版）

---

## 📌 目次

1. [アプリ概要](#1-アプリ概要)
2. [想定ユーザーとロール](#2-想定ユーザーとロール)
3. [ユーザー価値](#3-ユーザー価値)
4. [技術スタック](#4-技術スタック)
5. [機能仕様](#5-機能仕様)
6. [データモデル](#6-データモデル)
7. [エラーハンドリング](#7-エラーハンドリング)
8. [KPI・成功指標](#8-kpi成功指標)
9. [拡張ロードマップ](#9-拡張ロードマップ)
10. [改訂履歴](#10-改訂履歴)

---

## 1. アプリ概要

### 1-1. コンセプト

> **Waller（仮）は、ウォールトランポリンの「技」「挑戦」「成長」を気軽に共有できる場所をつくり、仲間やファンからの応援によって継続を後押しすることで、競技の魅力を広げ、新しく始める人も入りやすい文化を育てるコミュニティ型SNSである。**

### 1-2. 目的

- プレーヤーの「挑戦」「成長」「技の進化」を記録・共有
- ファンや同世代・同レベルのプレーヤーからの応援リアクションで継続意欲を高める
- 技が分からなくても気軽に応援できる仕組み

---

## 2. 想定ユーザーとロール

| ロール | 説明 | 投稿権限 | MVP対象 |
|---|---|---|---|
| **プレーヤー** | 自身の挑戦や技を記録・発信する競技者 | ✅ あり | ✅ 主要対象 |
| **ファン** | 応援・閲覧を中心に利用する家族/友人/興味層 | ❌ なし | ✅ 対象 |
| チーム/ジム運営者 | 所属組織管理・情報発信 | - | ❌ Phase2以降 |

---

## 3. ユーザー価値

### 3-1. プレーヤー価値

- ✅ 自分の技・挑戦を理解できる人に見てもらえる
- ✅ 同世代/同レベル/他地域の競技者に届きやすい
- ✅ 成長過程を記録できる
- ✅ 応援や共感を得やすい（🔥👏✨💪など）
- ✅ 孤立しがちな環境でも「つながり感」を得られる

### 3-2. ファン価値

- ✅ 推しや家族の成長を継続的に追える
- ✅ 同世代の挑戦を見ることで感情移入しやすい
- ✅ 技が分からなくてもスタンプで応援可能
- ✅ 新しいプレーヤー発見がしやすい

---

## 4. 技術スタック

### 4-1. 基盤技術

| 分類 | 技術 |
|---|---|
| **フロントエンド** | React Native (Expo) |
| **バックエンド** | Supabase |
| **認証** | Supabase Auth (Google/Apple) |
| **データベース** | Supabase PostgreSQL |
| **ストレージ** | Supabase Storage |

### 4-2. 動画処理方式

| 項目 | 仕様 |
|---|---|
| **選択** | expo-image-picker |
| **圧縮** | クライアント側で自動圧縮（videoExportPreset: MediumQuality） |
| **サムネイル生成** | expo-video-thumbnails（動画1秒目を自動抽出） |
| **アップロード先** | Supabase Storage |
| **対応形式** | MP4, MOV（H.264推奨、HEVCは自動変換） |

### 4-3. コスト想定

- **Supabase Pro**: $25/月
  - Storage: 100GB
  - 帯域幅: 200GB/月
- **想定**: 月間300投稿（10投稿/日）で運用可能

---

## 5. 機能仕様

### 5-1. 認証・プロフィール

#### 認証方式
- Google/Apple ログイン（Supabase Auth）

#### プロフィール項目

| 項目 | プレーヤー | ファン | 仕様 |
|---|---|---|---|
| **@ID** | 必須 | 必須 | 英数字+_、3〜15文字、小文字のみ、重複不可、**1回のみ変更可** |
| **表示名** | 必須 | 必須 | 1〜30文字、自由入力 |
| **アイコン** | 任意 | 任意 | 四角画像推奨、円形表示、最大5MB |
| **経験年数** | 必須 | - | 年+月で入力 |
| **スキルレベル** | 必須 | - | Lv1〜5の5段階、自己申告制 |
| **所属チーム** | 任意 | - | フリー入力 |
| **ホームジム** | 任意 | - | フリー入力 |
| **自己紹介** | 任意 | 任意 | 100文字まで |

#### スキルレベル定義（暫定）

| レベル | 名称 | 説明 |
|---|---|---|
| Lv1 | 初心者 | 始めたばかり、基本の跳び方を練習中 |
| Lv2 | 初級 | 基本技（バク転など）ができるようになってきた |
| Lv3 | 中級 | 複数の技を組み合わせられる |
| Lv4 | 上級 | 難易度の高い技（ダブルバクなど）に挑戦している |
| Lv5 | エキスパート | 大会出場レベル、独創的な技ができる |

※ 具体的な定義は専門家と相談の上、最終調整予定

#### プロフィール画面表示
- @ID / 表示名 / アイコン
- 経験年数・スキルレベル（小バッジ表示）
- 所属チーム / ホームジム
- 投稿グリッド表示
- 編集ボタン（本人のみ）

---

### 5-2. 投稿機能（プレーヤー限定）

#### 動画仕様

| 項目 | 仕様 |
|---|---|
| **長さ** | 3〜60秒 |
| **サイズ** | 最大100MB |
| **形式** | MP4, MOV（H.264推奨、HEVCは自動変換） |
| **縦横** | どちらも可（縦向き推奨） |

#### 入力項目

| 項目 | 必須/任意 | 仕様 |
|---|---|---|
| **動画** | 必須 | カメラロールから選択 |
| **キャプション** | 任意 | 200文字まで |
| **カテゴリタグ** | 任意 | 1つのみ選択（プリセット6種類） |

#### カテゴリタグ（プリセット）

| タグ | アイコン | 説明 |
|---|---|---|
| チャレンジ中 | 🔥 | 新しい技に挑戦している |
| 成功！ | 🎉 | 技が成功した |
| 練習記録 | 📝 | 日々の練習を記録 |
| 連続技 | 🔄 | 複数の技を組み合わせ |
| 新技 | ✨ | オリジナル技・新しい技 |
| その他 | - | 上記に当てはまらない |

※ 今後ユーザーの意見を元に変更予定

#### 投稿カード表示内容
- プレーヤー情報（@ID / 表示名 / アイコン）
- スキルレベル・経験年数バッジ
- 所属チーム / ホームジム（プロフィール連携）
- 動画（自動再生・ミュート）
- カテゴリタグ
- キャプション（1行表示、タップで全文）
- いいね数 / スタンプ内訳

#### 投稿後の編集・削除

| 操作 | 可否 | 仕様 |
|---|---|---|
| **編集** | ✅ 可能 | キャプション + カテゴリタグのみ編集可、動画は不可、回数制限なし |
| **削除** | ✅ 可能 | 完全削除（リアクションも消える）、削除制限あり |

#### 削除制限（スパム対策）
- **投稿後10分以内**: 何度でも削除OK
- **10分経過後**: 1日3回まで削除可能
- 制限超過時: 「本日の削除上限に達しました。明日以降に再度お試しください」

---

### 5-3. リアクション機能

#### リアクション種類

| 種類 | 仕様 |
|---|---|
| **いいね（❤️）** | トグル式、1投稿につき1ユーザー1回 |
| **スタンプ** | 🔥やばい / 👏ナイス / ✨きれい / 💪チャレンジ |

#### スタンプルール
- **同時選択**: 1投稿につき1種類のみ有効
- **変更制限**:
  - 送信後10分以内: 自由に変更可能
  - 10分経過後: 変更にクールダウン30秒
- クールダウン中: 「スタンプの変更は30秒後に可能です」+ カウントダウン表示

#### いいね履歴機能
- ✅ 「自分がいいねした投稿一覧」をマイページに表示
- ✅ 本人のみ閲覧可能（他人からは見えない）
- ✅ いいね解除した投稿は履歴から消える
- ✅ 投稿者が削除した投稿は履歴から消える

---

### 5-4. フィード機能

#### フィード種類

| 種別 | 対象 | 並び順 |
|---|---|---|
| **ホームフィード** | 全プレーヤーの投稿 | 新着順（created_at DESC） |
| **プロフィールフィード** | 特定ユーザーの投稿のみ | 新着順 |
| **いいね履歴フィード** | 自分がいいねした投稿 | いいねした順 |

#### 表示仕様
- **自動再生**: ミュートで1投稿のみ
- **ページング**: 10件ずつ、下部スクロールで自動読み込み
- **初回表示**: サンプル投稿を配置（投稿ゼロ状態を避ける）

#### サンプル投稿
- 運営が作成したデモ投稿（3〜5本程度）
- ユーザーが増えたら段階的に削除

---

### 5-5. 通報機能

#### 通報対象
- ✅ 投稿単位のみ（ユーザー通報は無し）

#### 通報フロー

```
1. 投稿カードの「⋯」メニュー → 「投稿を通報」
2. 通報理由を選択
   ○ 不適切なコンテンツ（暴力的・性的な内容）
   ○ スパム・宣伝
   ○ 嫌がらせ・誹謗中傷
   ○ なりすまし
   ○ その他（自由記述100文字）
3. 「通報する」ボタン押下
4. 即時フィードバック:
   「✅ 通報を受け付けました
    ご報告ありがとうございます。
    内容を確認の上、適切に対応いたします。」
```

#### 通報後の処理
- **3人以上が通報** → 自動的に全ユーザーから非表示
- 運営が週数回チェック → 削除 or 復活判定
- 同じユーザーが同じ投稿を複数回通報は不可

---

### 5-6. ユーザーフロー

#### 初回登録（プレーヤー）
```
1. Google/Apple ログイン
2. ロール選択（プレーヤー / ファン）
3. @ID・表示名入力
4. 経験年数・スキルレベル入力
5. （任意）所属チーム/ホームジム/自己紹介
6. ホームフィードへ → 投稿案内表示
```

#### 初回登録（ファン）
```
1. Google/Apple ログイン
2. ロール選択（プレーヤー / ファン）
3. @ID・表示名入力
4. （任意）自己紹介
5. ホームフィードへ
```

#### 通常利用サイクル

**プレーヤー**:
```
視聴 → 投稿 → リアクションをもらう → 継続投稿
```

**ファン**:
```
視聴 → リアクション → いいね履歴で推しの動画を再視聴
```

---

## 6. データモデル

### 6-1. users（ユーザー基本情報）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK, Supabase Auth連携 |
| role | TEXT | ✅ | 'player' or 'fan' |
| username | TEXT | ✅ | @ID、英数字+_、3〜15文字、重複不可 |
| display_name | TEXT | ✅ | 表示名、1〜30文字 |
| avatar_url | TEXT | - | アイコン画像URL |
| bio | TEXT | - | 自己紹介、100文字まで |
| username_change_count | INTEGER | ✅ | @ID変更回数（最大1回） |
| status | TEXT | ✅ | 'active' / 'suspended' / 'deleted' |
| created_at | TIMESTAMPTZ | ✅ | 登録日時 |
| updated_at | TIMESTAMPTZ | ✅ | 更新日時 |
| last_login_at | TIMESTAMPTZ | - | 最終ログイン（7日再訪率計測用） |

### 6-2. player_profiles（プレーヤー専用情報）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| user_id | UUID | ✅ | FK → users.id |
| experience_years | INTEGER | ✅ | 経験年数（年） |
| experience_months | INTEGER | ✅ | 経験年数（月） |
| skill_level | INTEGER | ✅ | 1〜5 |
| team_name | TEXT | - | 所属チーム |
| home_gym | TEXT | - | ホームジム |

### 6-3. posts（投稿）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK |
| user_id | UUID | ✅ | FK → users.id |
| video_url | TEXT | ✅ | Supabase Storage URL |
| thumbnail_url | TEXT | ✅ | サムネイルURL |
| video_duration | INTEGER | ✅ | 動画秒数 |
| video_size | BIGINT | ✅ | 動画サイズ（バイト） |
| caption | TEXT | - | 200文字まで |
| category_tag | TEXT | - | 'challenge' / 'success' / 'practice' / 'combo' / 'new' / 'other' |
| status | TEXT | ✅ | 'published' / 'deleted' / 'reported' |
| created_at | TIMESTAMPTZ | ✅ | 投稿日時 |
| updated_at | TIMESTAMPTZ | ✅ | 更新日時 |

**インデックス**:
```sql
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_status ON posts(status);
```

### 6-4. likes（いいね）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK |
| post_id | UUID | ✅ | FK → posts.id |
| user_id | UUID | ✅ | FK → users.id |
| created_at | TIMESTAMPTZ | ✅ | いいね日時 |

**ユニーク制約**: (post_id, user_id)

### 6-5. reactions（スタンプ）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK |
| post_id | UUID | ✅ | FK → posts.id |
| user_id | UUID | ✅ | FK → users.id |
| reaction_type | TEXT | ✅ | 'fire' / 'clap' / 'sparkle' / 'muscle' |
| previous_type | TEXT | - | 変更前のスタンプ種類 |
| created_at | TIMESTAMPTZ | ✅ | 送信日時 |
| updated_at | TIMESTAMPTZ | ✅ | 変更日時（10分ルール判定用） |

**ユニーク制約**: (post_id, user_id)

### 6-6. post_counters（カウンター・非正規化）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| post_id | UUID | ✅ | FK → posts.id |
| like_count | INTEGER | ✅ | いいね数 |
| reaction_fire_count | INTEGER | ✅ | 🔥の数 |
| reaction_clap_count | INTEGER | ✅ | 👏の数 |
| reaction_sparkle_count | INTEGER | ✅ | ✨の数 |
| reaction_muscle_count | INTEGER | ✅ | 💪の数 |
| updated_at | TIMESTAMPTZ | ✅ | 更新日時 |

※ パフォーマンス最適化のため、トリガーで自動更新

### 6-7. reports（通報）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK |
| post_id | UUID | ✅ | FK → posts.id |
| reporter_user_id | UUID | ✅ | FK → users.id |
| reason | TEXT | ✅ | 'inappropriate' / 'spam' / 'harassment' / 'impersonation' / 'other' |
| reason_detail | TEXT | - | 自由記述（100文字） |
| status | TEXT | ✅ | 'pending' / 'resolved' / 'dismissed' |
| created_at | TIMESTAMPTZ | ✅ | 通報日時 |

**ユニーク制約**: (post_id, reporter_user_id)

### 6-8. deletion_logs（削除履歴・スパム対策）

| カラム | 型 | 必須 | 説明 |
|---|---|---|---|
| id | UUID | ✅ | PK |
| user_id | UUID | ✅ | FK → users.id |
| post_id | UUID | ✅ | 削除された投稿ID |
| deleted_at | TIMESTAMPTZ | ✅ | 削除日時 |

※ 削除制限（1日3回）の判定に使用

---

## 7. エラーハンドリング

### 7-1. 動画アップロード関連

| エラーケース | 検出タイミング | メッセージ | 対処 |
|---|---|---|---|
| ファイルサイズ超過（100MB超） | 動画選択直後 | 動画サイズが大きすぎます（100MB以下にしてください） | 別の動画を選択 |
| 動画が3秒未満 | 動画選択直後 | 動画の長さは3〜60秒にしてください | 別の動画を選択 |
| 動画が60秒超過 | 動画選択直後 | 動画の長さは3〜60秒にしてください | 別の動画を選択 |
| 非対応形式 | 動画選択直後 | この動画は対応していません。別の動画を選択してください | 別の動画を選択 |
| サムネイル生成失敗 | 投稿処理中 | サムネイルの生成に失敗しました。もう一度お試しください | [再試行]ボタン |
| アップロード中断 | アップロード中 | アップロードに失敗しました。ネットワーク接続を確認してください | [再試行]ボタン |
| Storageエラー | アップロード中 | 現在アップロードできません。しばらくしてから再試行してください | [再試行]ボタン |
| 認証切れ | 投稿ボタン押下時 | セッションが切れました。ログインし直してください | ログイン画面へ |

### 7-2. 一般的なエラー

| エラーケース | 検出タイミング | メッセージ | 対処 |
|---|---|---|---|
| オフライン状態 | 各種操作時 | インターネット接続を確認してください | 接続後に再試行 |
| データ読み込み失敗 | フィード表示時 | 投稿の読み込みに失敗しました | [再読み込み]ボタン |
| リアクション送信失敗 | いいね/スタンプ押下時 | リアクションの送信に失敗しました | 楽観的更新ロールバック |
| プロフィール更新失敗 | 保存ボタン押下時 | プロフィールの更新に失敗しました | [再試行]ボタン |
| 画像アップロード失敗 | アイコン設定時 | 画像のアップロードに失敗しました | [再試行]ボタン |
| @ID重複 | プロフィール登録/変更時 | このIDは既に使用されています | 別のIDを入力 |
| @ID不正な形式 | プロフィール登録/変更時 | IDは英数字と_のみ、3〜15文字で入力してください | 修正して再入力 |

### 7-3. スパム/制限系エラー

| エラーケース | 検出タイミング | メッセージ | 対処 |
|---|---|---|---|
| 削除回数制限超過 | 削除ボタン押下時 | 本日の削除上限に達しました。明日以降に再度お試しください | 翌日まで待つ |
| スタンプ変更クールダウン中 | スタンプ変更時 | スタンプの変更は30秒後に可能です（カウントダウン表示） | 30秒待つ |
| @ID変更回数超過 | @ID変更時 | IDの変更は1回のみ可能です | 変更不可 |

### 7-4. 通報関連

| エラーケース | 検出タイミング | メッセージ | 対処 |
|---|---|---|---|
| 通報送信失敗 | 通報ボタン押下時 | 通報の送信に失敗しました。もう一度お試しください | [再試行]ボタン |
| 同じ投稿を複数回通報 | 通報ボタン押下時 | この投稿は既に通報済みです | 通報不可 |

### 7-5. エラー表示UI方針

| 表示方法 | 用途 | 例 |
|---|---|---|
| **モーダル** | 重要なエラー、ユーザーの操作が必要 | アップロード前バリデーション、認証エラー、削除回数制限 |
| **トースト** | 軽微なエラー、3秒後に自動消去 | リアクション失敗、データ読み込み失敗 |
| **インライン** | 入力フォームのエラー | @ID形式エラー、バリデーションエラー |

---

## 8. KPI・成功指標

### 8-1. MVP成功基準

| KPI | 目標値 | 測定方法 |
|---|---|---|
| **週投稿者数** | 8人以上 | users.last_login_at + posts.created_at |
| **平均リアクション率** | 25%以上 | (いいね+スタンプ総数) / 投稿数 |
| **7日再訪率** | 35%以上 | 登録後7日以内に2回以上ログインしたユーザー割合 |

### 8-2. 追加観測指標

- 投稿あたりの平均視聴時間
- いいね履歴の利用率
- カテゴリタグの利用分布
- 通報発生率

---

## 9. 拡張ロードマップ

### Phase 0（MVP）← 現在
- ✅ 投稿（プレーヤー限定）
- ✅ 視聴（新着順フィード）
- ✅ リアクション（いいね + スタンプ4種）
- ✅ いいね履歴
- ✅ 通報機能

### Phase 1（発見性強化）
- タグ検索 / タグタップでフィルタ
- カテゴリタグ別フィード
- 通知機能（軽量版）
- プレイサマリー（月間投稿数、もらったリアクション総数）

### Phase 2（コミュニケーション解禁）
- コメント機能（制限付き）
- フォロー機能（UIのみ、フォロー中フィードは無し）
- ファン投稿（承認型β）

### Phase 3（エンゲージメント強化）
- フォロー中フィード
- チャレンジ機能
- スタンプ拡張（有償含む）
- チーム/ジムページ
- ランキング

---

## 10. 改訂履歴

| Version | 日付 | 内容 |
|---|---|---|
| v0.1 | - | 構想初版 |
| v0.2 | - | ユーザー価値・MVP定義 |
| v0.3 | - | 機能仕様整理＋全STEP反映 |
| **v0.4** | 2025-10-21 | **MVP確定版**: 技術スタック確定、タグ仕様簡素化、編集・削除ルール確定、通報機能詳細化、エラーハンドリング網羅、データモデル詳細化 |

---

## 📌 受け入れ基準（MVP完成判定）

- ✅ プレーヤーが動画付き投稿を完了できる
- ✅ ファンがリアクション（いいね・スタンプ）できる
- ✅ 投稿が新着順で閲覧できる
- ✅ いいね履歴が自分専用で閲覧可能
- ✅ 通報機能が動作する（3人通報で自動非表示）
- ✅ 投稿編集・削除が仕様通りに動作する
- ✅ スタンプ変更ルール（10分以内自由、以降30秒CD）が動作する
- ✅ 削除制限（10分以内無制限、以降1日3回）が動作する
- ✅ すべての主要エラーケースで適切な案内が表示される

---

## 📝 今後の検討課題

- コメント機能の設計（Phase2）
- チーム文化の正しい扱い方
- 年代別の共感導線
- ガイドラインとモデレーション体制
- 外部シェア導線（Instagram, Twitter等）
- プライバシー設定（鍵垢機能）
- ブロック機能
- 未成年保護・COPPA対応

---

**END OF DOCUMENT**